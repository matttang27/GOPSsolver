name: Cpp Cache Exploitability Parity

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:
  cpp-cache-exploitability-parity:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libglpk-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build cpp_solver
        run: |
          cmake -S solver -B solver/build -DCMAKE_BUILD_TYPE=Release
          cmake --build solver/build --config Release --parallel

      - name: Generate n=6 win cache
        run: |
          ./solver/build/cpp_solver --n 6 --cache-out reports/full6_ci.evc

      - name: Generate n=6 points cache
        run: |
          ./solver/build/cpp_solver --n 6 --objective points --cache-out reports/full6points_ci.evc

      - name: Run exploitability checks (win + points)
        run: |
          python ai/exploitability.py --policy evc-ne --cache reports/full6_ci.evc --n 6 --json-out reports/full6_ci.exploitability.json
          python ai/exploitability.py --policy evc-ne --cache reports/full6points_ci.evc --n 6 --json-out reports/full6points_ci.exploitability.json

      - name: Assert exploitability near zero
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          checks = [
              (Path("reports/full6_ci.exploitability.json"), "win"),
              (Path("reports/full6points_ci.exploitability.json"), "points"),
          ]
          threshold = 1e-8

          for path, expected_obj in checks:
              data = json.loads(path.read_text(encoding="utf-8"))
              actual_obj = data.get("strategy_objective")
              if actual_obj != expected_obj:
                  raise SystemExit(
                      f"{path}: expected strategy_objective={expected_obj}, got {actual_obj}"
                  )
              exploitability = float(data["avg_max_exploitability"])
              if abs(exploitability) > threshold:
                  raise SystemExit(
                      f"{path}: avg_max_exploitability={exploitability} exceeds {threshold}"
                  )
          print("Exploitability checks passed.")
          PY

      - name: Run C++ CLI and parity tests
        env:
          GOPS_CPP_SOLVER: ${{ github.workspace }}/solver/build/cpp_solver
        run: |
          python -m unittest tests.test_cpp_solver_cli tests.test_solver_parity_cpp_python -v

      - name: Upload generated caches and reports
        uses: actions/upload-artifact@v4
        with:
          name: n6-caches-and-exploitability
          path: |
            reports/full6_ci.evc
            reports/full6_ci.evc.json
            reports/full6points_ci.evc
            reports/full6points_ci.evc.json
            reports/full6_ci.exploitability.json
            reports/full6points_ci.exploitability.json
